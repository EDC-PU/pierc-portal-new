
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAdmin() {
      // Check if the requesting user has the 'ADMIN_FACULTY' role in their user profile.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN_FACULTY';
    }

    function isSuperAdmin() {
      // Check if the requesting user is a Super Admin.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }

    function isOwner(userId) {
      // Check if the requesting user is the owner of the document.
      return request.auth.uid == userId;
    }

    // --- Users Collection Rules ---
    match /users/{userId} {
      // READ: Any user can read their own profile. Admins can read any profile.
      allow read: if isOwner(userId) || isAdmin();

      // CREATE: A user can create their own profile, as long as they are not trying to grant themselves admin privileges.
      allow create: if isOwner(userId) 
                    && request.resource.data.isSuperAdmin == false
                    && request.resource.data.role != 'ADMIN_FACULTY';

      // UPDATE: An admin can update any profile. A user can update their own profile, but cannot change their role or admin status.
      allow update: if isAdmin() || (isOwner(userId) 
                    && request.resource.data.role == resource.data.role 
                    && request.resource.data.isSuperAdmin == resource.data.isSuperAdmin);
                    
      // DELETE: Only a super admin can delete user profiles (action is performed via a callable function).
      allow delete: if isSuperAdmin();
    }

    // --- Ideas Collection Rules ---
    match /ideas/{ideaId} {
      // READ: Any authenticated user can read ideas.
      allow read: if request.auth != null;

      // CREATE: The idea can only be created by the user specified in the document's `userId` field.
      allow create: if request.auth.uid == request.resource.data.userId;

      // UPDATE & DELETE: Only the idea owner or an admin can update/delete idea fields.
      // Any authenticated user can add a comment.
      allow update: if (isOwner(resource.data.userId) || isAdmin());
      
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // --- Other Collections ---
    match /{collection}/{docId} {
        // DEFAULT RULES for other collections (announcements, cohorts, systemSettings, etc.)
        // These are primarily managed by admins.
        allow read: if request.auth != null; // Allow any authenticated user to read
        allow write: if isAdmin(); // Only admins can create, update, delete
    }
  }
}
